{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Detalles del Producto Fabricado</h1>

    <div class="mb-3">
        <h3 class="card-title">{{ producto.nombre }}</h3>
    </div>

    <h3>Ingredientes</h3>
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>Nombre</th>
                <th>Costo Factura</th>
                <th>Cantidad Factura</th>
                <th>Cantidad Ing</th>
                <th>Unidad Medida</th>
                <th>Costo Ing Por Producto</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for ingrediente in ingredientes %}
            <tr data-id="{{ ingrediente.ingrediente_id }}">
                <td>{{ ingrediente.nombre }}</td>
                <td class="editable-cell">
                    <span class="display-value">{{ ingrediente.costo_factura }}</span>
                    <input type="number" 
                        class="form-control form-control-sm edit-input d-none" 
                        name="costo_factura"
                        value="{{ ingrediente.costo_factura }}"
                        placeholder="Costo Factura"
                        step="0.01"
                        min="0">
                </td>
                <td class="editable-cell">
                    <span class="display-value">{{ ingrediente.cantidad_factura }}</span>
                    <select class="form-select form-select-sm edit-input d-none" name="cantidad_factura">
                        <option value="">Seleccione</option>
                        {% for unidad in ['gramos', 'kilos', 'litros', 'mililitros', 'cc', 'galon', 'garrafa'] %}
                        <option value="{{ unidad }}" {% if unidad == ingrediente.cantidad_factura %}selected{% endif %}>
                            {{ unidad|title }}
                        </option>
                        {% endfor %}
                    </select>
                </td>
                <td class="editable-cell">
                    <span class="display-value">{{ ingrediente.cantidad_ing }}</span>
                    <input type="number" 
                        class="form-control form-control-sm edit-input d-none" 
                        name="cantidad_ing"
                        value="{{ ingrediente.cantidad_ing }}"
                        placeholder="Cantidad Ing"
                        step="0.01"
                        min="0">
                </td>                
                <td class="editable-cell">
                    <span class="display-value">{{ ingrediente.unidad_medida }}</span>
                    <select class="form-select form-select-sm edit-input d-none" name="unidad_medida">
                        <option value="">Seleccione</option>
                        {% for unidad in ['gramos', 'kilos', 'litros', 'mililitros', 'cc', 'galon', 'garrafa'] %}
                        <option value="{{ unidad }}" {% if unidad == ingrediente.unidad_medida %}selected{% endif %}>
                            {{ unidad|title }}
                        </option>
                        {% endfor %}
                    </select>
                </td>
                <td class="costo-producto">
                    <span>{{ ingrediente.costo_ing_por_producto }}</span>
                </td>
                <td>
                    <button class="btn btn-primary btn-sm edit-button">
                        Editar
                    </button>
                    <div class="btn-group d-none save-cancel-buttons">
                        <button class="btn btn-success btn-sm save-button">
                            Guardar
                        </button>
                        <button class="btn btn-secondary btn-sm cancel-button">
                            Cancelar
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="row mt-3">
        <div class="col-md-6">
            <div class="input-group mb-3">
                <span class="input-group-text">Costo de Empaque</span>
                <input type="number" 
                    id="costoEmpaque" 
                    class="form-control" 
                    value="0" 
                    min="0" 
                    step="0.01" 
                    onchange="actualizarCostoTotal()">
            </div>
        </div>
        <div class="col-md-6">
            <h4>Subtotal Ingredientes: <span id="subtotalIngredientes">$0.00</span></h4>
            <h4>Costo Total (con empaque): <span id="costoTotal">$0.00</span></h4>
        </div>
    </div>
</div>

</div>

    <script>
        // Función para validar que todos los campos requeridos estén completos
        function validateRow(row) {
            const validationData = {
                isValid: true,
                formData: new FormData(),
                errors: []
            };

            // Verificar el ID del ingrediente
            const ingredienteId = row.dataset.id;
            if (!ingredienteId) {
                validationData.errors.push('ID del ingrediente no encontrado');
                validationData.isValid = false;
                return validationData;
            }
            validationData.formData.append('ingrediente_id', ingredienteId);

            // Validar cada campo editable
            const fields = [
                { name: 'costo_factura', type: 'number', min: 0 },
                { name: 'cantidad_factura', type: 'select' },
                { name: 'cantidad_ing', type: 'number', min: 0 },
                { name: 'unidad_medida', type: 'select' }
            ];

            fields.forEach(field => {
                const input = row.querySelector(`[name="${field.name}"]`);
                if (!input) {
                    validationData.errors.push(`Campo ${field.name} no encontrado`);
                    validationData.isValid = false;
                    return;
                }

                const value = input.value.trim();
                
                if (!value) {
                    input.classList.add('is-invalid');
                    validationData.errors.push(`${field.name} es requerido`);
                    validationData.isValid = false;
                    return;
                }

                if (field.type === 'number') {
                    const numValue = parseFloat(value);
                    if (isNaN(numValue) || numValue < field.min) {
                        input.classList.add('is-invalid');
                        validationData.errors.push(`${field.name} debe ser un número válido mayor a ${field.min}`);
                        validationData.isValid = false;
                        return;
                    }
                }

                input.classList.remove('is-invalid');
                validationData.formData.append(field.name, value);
            });

            // Agregar el costo por producto calculado
            const costoProducto = row.querySelector('.costo-producto span').textContent;
            validationData.formData.append('costo_ing_por_producto', costoProducto.replace(/[^0-9.]/g, ''));

            return validationData;
        }
        // Mapa de conversiones entre unidades
        const conversiones = {
            'gramos': { 'kilos': 0.001, 'litros': 0.001, 'mililitros': 1, 'cc': 1, 'galon': 0.000264172, 'garrafa': 0.00005 },
            'kilos': { 'gramos': 1000, 'litros': 1, 'mililitros': 1000, 'cc': 1000, 'galon': 0.264172, 'garrafa': 0.05 },
            'litros': { 'gramos': 1000, 'kilos': 1, 'mililitros': 1000, 'cc': 1000, 'galon': 0.264172, 'garrafa': 0.05 },
            'mililitros': { 'gramos': 1, 'kilos': 0.001, 'litros': 0.001, 'cc': 1, 'galon': 0.000264172, 'garrafa': 0.00005 },
            'cc': { 'gramos': 1, 'kilos': 0.001, 'litros': 0.001, 'mililitros': 1, 'galon': 0.000264172, 'garrafa': 0.00005 },
            'galon': { 'gramos': 4000, 'kilos': 4, 'litros': 4, 'mililitros': 4000, 'cc': 4000, 'garrafa': 0.2 },
            'garrafa': { 'gramos': 20000, 'kilos': 20, 'litros': 20, 'mililitros': 20000, 'cc': 20000, 'galon': 5 }
        };

        function convertirUnidades(cantidad, unidadOrigen, unidadDestino) {
            if (!cantidad || !unidadOrigen || !unidadDestino) return null;
            if (unidadOrigen === unidadDestino) return cantidad;
            const factor = conversiones[unidadOrigen]?.[unidadDestino];
            if (!factor) throw new Error(`No hay conversión definida entre ${unidadOrigen} y ${unidadDestino}`);
            return cantidad * factor;
        }

        document.addEventListener('DOMContentLoaded', function() {
            actualizarCostoTotal();

            // Add event listeners for edit buttons
            document.querySelectorAll('.edit-button').forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');
                    toggleEditMode(row, true);
                });
            });

            // Add event listeners for cancel buttons
            document.querySelectorAll('.cancel-button').forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');
                    toggleEditMode(row, false);
                });
            });

            // Add event listeners for save buttons
            document.querySelectorAll('.save-button').forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');
                    saveChanges(row);
                });
            });

            // Add change handlers for inputs and selects to calculate cost
            document.querySelectorAll('.edit-input').forEach(input => {
                input.addEventListener('change', function() {
                    const row = this.closest('tr');
                    calculateCost(row);
                });
            });
        });

        function toggleEditMode(row, editMode) {
            row.querySelectorAll('.display-value').forEach(elem => {
                elem.classList.toggle('d-none', editMode);
            });
            row.querySelectorAll('.edit-input').forEach(elem => {
                elem.classList.toggle('d-none', !editMode);
            });
            row.querySelector('.edit-button').classList.toggle('d-none', editMode);
            row.querySelector('.save-cancel-buttons').classList.toggle('d-none', !editMode);
        }

        function calculateCost(row) {
            const costoFactura = parseFloat(row.querySelector('input[name="costo_factura"]').value) || 0;
            const cantidadIng = parseFloat(row.querySelector('input[name="cantidad_ing"]').value) || 0;
            const unidadMedida = row.querySelector('select[name="unidad_medida"]').value;
            const cantidadFactura = row.querySelector('select[name="cantidad_factura"]').value;

            // Validación de valores
            if (costoFactura <= 0 || cantidadIng <= 0 || !unidadMedida || !cantidadFactura) {
                row.querySelector('.costo-producto span').textContent = "0.00";
                return;
            }

            try {
                // Convertimos la cantidad del ingrediente a la unidad de la factura
                const cantidadConvertida = convertirUnidades(cantidadIng, unidadMedida, cantidadFactura);
                if (cantidadConvertida === null) {
                    throw new Error("Error en la conversión de unidades");
                }
                
                // Calculamos el costo por producto basado en la cantidad convertida
                const costoPorProducto = (costoFactura * cantidadConvertida).toFixed(2);
                
                row.querySelector('.costo-producto span').textContent = costoPorProducto;
                actualizarCostoTotal();
            } catch (error) {
                console.error(`Error en cálculo: ${error.message}`);
                row.querySelector('.costo-producto span').textContent = "0.00";
            }
        }

        function saveChanges(row) {
            // Validar la fila y obtener datos
            const validation = validateRow(row);
            if (!validation.isValid) {
                console.error("Errores de validación:", validation.errors);
                alert('Por favor corrija los siguientes errores:\n' + validation.errors.join('\n'));
                return;
            }

            // Debug: Mostrar datos que se enviarán
            console.log('Datos a enviar:');
            validation.formData.forEach((value, key) => {
                console.log(`${key}: ${value}`);
            });

            // Enviar datos al servidor
            fetch('{{ url_for("fabricante_ingredientes.editar") }}', {
                method: 'POST',
                body: validation.formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => Promise.reject(data));
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Actualizar los valores mostrados
                    row.querySelectorAll('.editable-cell').forEach(cell => {
                        const displaySpan = cell.querySelector('.display-value');
                        const input = cell.querySelector('.edit-input');
                        if (displaySpan && input) {
                            displaySpan.textContent = input.value;
                        }
                    });
                    
                    toggleEditMode(row, false);
                    actualizarCostoTotal();
                    
                    // Mostrar mensaje de éxito
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show mt-2';
                    alert.innerHTML = `
                        Actualización exitosa
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    row.closest('.container').insertBefore(alert, row.closest('table'));
                    
                    // Auto-ocultar el mensaje después de 3 segundos
                    setTimeout(() => {
                        alert.remove();
                    }, 3000);
                }
            })
            .catch(error => {
                const errorMessage = error.message || 'Error al actualizar el ingrediente';
                
                // Mostrar mensaje de error
                const alert = document.createElement('div');
                alert.className = 'alert alert-danger alert-dismissible fade show mt-2';
                alert.innerHTML = `
                    ${errorMessage}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                row.closest('.container').insertBefore(alert, row.closest('table'));
                
                console.error('Error:', error);
            });
        }


        function actualizarCostoTotal() {
            let subtotalIngredientes = 0;
            const celdasCosto = document.querySelectorAll('.costo-producto span');
            celdasCosto.forEach(celda => {
                const valor = parseFloat(celda.textContent.trim()) || 0;
                subtotalIngredientes += valor;
            });
            
            const costoEmpaque = parseFloat(document.getElementById('costoEmpaque').value) || 0;
            const costoTotal = subtotalIngredientes + costoEmpaque;

            document.getElementById('subtotalIngredientes').textContent = `$${subtotalIngredientes.toFixed(2)}`;
            document.getElementById('costoTotal').textContent = `$${costoTotal.toFixed(2)}`;
        }
    </script>

<style>
.d-none {
    display: none !important;
}
</style>
{% endblock %}